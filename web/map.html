

<!DOCTYPE html>
<html>
    <head>
        <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
        <meta charset="utf-8">
        <title>Reverse Geocoding</title>
        <style>
            html, body, #map-canvas {
                height: 100%;
                margin: 0px;
                padding: 0px
            }
            #panel {
                position: absolute;
                top: 5px;
                left: 50%;
                margin-left: -180px;
                z-index: 5;
                background-color: #fff;
                padding: 5px;
                border: 1px solid #999;
            }
        </style>
        <script src="https://maps.googleapis.com/maps/api/js?v=3.exp&signed_in=true"></script>
        <script>
            var geocoder;
            var map;
            var infowindow = new google.maps.InfoWindow();
            var marker;

            function initialize() {
                /*geocoder = new google.maps.Geocoder();
                var latlng = new google.maps.LatLng(36.5806067, 10.862080399999968);
                var mapOptions = {
                    zoom: 15,
                    center: latlng,
                    mapTypeId: 'roadmap'
                };
                map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);*/
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(function (position) {
                        var pos = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        /**/
                        geocoder = new google.maps.Geocoder();
                        var latlng = new google.maps.LatLng(pos.lat, pos.lng);
                        var mapOptions = {
                            zoom: 15,
                            center: latlng,
                            mapTypeId: 'roadmap'
                        };
                        map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);
                        codeLatLng(pos.lat, pos.lng);
                        /**/
                        alert('Location found.');
                    }, function () {
                        alert("success");
                    });
                } else {
                    // Browser doesn't support Geolocation
                    alert("failure");
                }
            }

            function codeLatLng(lat, lng) {
                /*var input = document.getElementById('latlng').value;
                var latlngStr = input.split(',', 2);
                var lat = parseFloat(latlngStr[0]);
                var lng = parseFloat(latlngStr[1]);*/
                //alert(lat);
                var latlng = new google.maps.LatLng(lat, lng);
                geocoder.geocode({'latLng': latlng}, function (results, status) {
                if (status === google.maps.GeocoderStatus.OK) {
                        if (results[1]) {
                            var Gouvernorats = ["Ariana", "Bèja", "Ben Arous", "Bizerte", "Gabès", "Gafsa", "Jendouba", "Kairouan", "Kasserine", 
                            "Kébili", "Kef", "Mahdia", "Manouba", "Médenine", "Monastir", "Nabeul", "Sfax", "Sidi Bouzid", "Siliana", 
                            "Sousse", "Tataouine", "Tozeur", "Tunis", "Zaghouan"];
                            var done1 = false, done2 = false, ville = "", gouvernorat = "";
                            for(i=1; i<results.length; i++){
                                var a = results[i].address_components;
                                for(j=0; j<a.length && (!done1 || !done2); j++){
                                    if(!done2 && a[j].types[0] === "administrative_area_level_2") {
                                        done2 = true; 
                                        ville = a[j].long_name;
                                        for (var g = 0; g < Gouvernorats.length; g++) 
                                            if(ville.includes(Gouvernorats[g]) || ville.replace(/[éè]/g, "e").includes(Gouvernorats[g].replace(/[éè]/g, "e"))) {
                                                gouvernorat = ville = Gouvernorats[g];
                                                done1 = true;
                                                break;
                                            }
                                    }
                                    if(!done1 && a[j].types[0] === "administrative_area_level_1") {
                                        gouvernorat = a[j].long_name;
                                        for (var g = 0; g < Gouvernorats.length; g++)
                                            if(gouvernorat.includes(Gouvernorats[g]) || gouvernorat.replace(/[éè]/g, "e").includes(Gouvernorats[g].replace(/[éè]/g, "e"))){
                                                gouvernorat = Gouvernorats[g];
                                                done1 = true;
                                                break;
                                            }
                                        done1 = true;
                                    }
                                }
                            }
                            if(gouvernorat === "") gouvernorat = "Tunis";
                            if(ville == "") ville = gouvernorat;

                            alert(ville + " " + gouvernorat + " "+ results[0].formatted_address);
                            
                            map.setZoom(15);
                            marker = new google.maps.Marker({
                                position: latlng,
                                map: map
                            });
                            var str = results[1].formatted_address;
                            var n = str.indexOf(",");
                            var res = str.slice(0, n);
                            document.getElementById('ville').value = res;
                            infowindow.setContent(results[0].formatted_address);
                            infowindow.open(map, marker);
                        } else {
                            alert('No results found');
                        }
                    } else {
                        alert('Geocoder failed due to: ' + status);
                    }
                });
            }

            google.maps.event.addDomListener(window, 'load', initialize);

        </script>
        <style>
            #panel {
                position: absolute;
                top: 5px;
                left: 50%;
                margin-left: -180px;
                width: 350px;
                z-index: 5;
                background-color: #fff;
                padding: 5px;
                border: 1px solid #999;
            }
            #latlng {
                width: 225px;
            }
        </style>
    </head>
    <body>
        <div id="panel">
            <input id="latlng" type="text" value="36.5806067, 10.862080399999968">
            <input type="button" value="Reverse Geocode" onclick="codeLatLng(document.getElementById('latlng').value.split(',')[0],document.getElementById('latlng').value.split(',')[1])">
            <input type="text" id="ville" value="ville" >
        </div>
        <div id="map-canvas"></div>
    </body>
</html>

